<div class="citizen-requests">
  <div class="page-header">
    <div class="header-content">
      <h1>Demandes citoyens</h1>
      <p>Gérez et traitez les demandes des citoyens</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="exportRequests()">
        <i class="material-icons">download</i>
        Exporter
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-row">
    <div class="stat-card pending">
      <div class="stat-icon">
        <i class="material-icons">pending</i>
      </div>
      <div class="stat-info">
   <h3>{{ getPendingRequests().length }}</h3>
        <p>En attente</p>
      </div>
    </div>
    <div class="stat-card progress">
      <div class="stat-icon">
        <i class="material-icons">hourglass_empty</i>
      </div>
      <div class="stat-info">
      <h3>{{ getInProgressRequests().length }}</h3>
        <p>En cours</p>
      </div>
    </div>
    <div class="stat-card completed">
      <div class="stat-icon">
        <i class="material-icons">check_circle</i>
      </div>
      <div class="stat-info">
          <h3>{{ getCompletedRequests().length }}</h3>
        <p>Terminées</p>
      </div>
    </div>
    <div class="stat-card urgent">
      <div class="stat-icon">
        <i class="material-icons">priority_high</i>
      </div>
      <div class="stat-info">
       <h3>{{ getUrgentRequests().length }}</h3>
        <p>Urgentes</p>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="search-box">
      <i class="material-icons">search</i>
      <input 
        type="text" 
        placeholder="Rechercher une demande..." 
        [(ngModel)]="searchTerm"
        (input)="filterRequests()">
    </div>
    
    <div class="filter-controls">
      <select [(ngModel)]="selectedType" (change)="filterRequests()" class="form-select">
        <option value="">Tous les types</option>
        <option *ngFor="let type of requestTypes" [value]="type">{{type}}</option>
      </select>
      
      <select [(ngModel)]="selectedStatus" (change)="filterRequests()" class="form-select">
        <option value="">Tous les statuts</option>
        <option value="pending">En attente</option>
        <option value="in_progress">En cours</option>
        <option value="completed">Terminé</option>
        <option value="rejected">Rejeté</option>
      </select>
      
      <select [(ngModel)]="selectedPriority" (change)="filterRequests()" class="form-select">
        <option value="">Toutes les priorités</option>
        <option value="low">Faible</option>
        <option value="medium">Moyenne</option>
        <option value="high">Élevée</option>
        <option value="urgent">Urgente</option>
      </select>
    </div>
  </div>

  <!-- Requests List -->
  <div class="requests-list">
    <div class="request-card" *ngFor="let request of filteredRequests" (click)="openRequestModal(request)">
      <div class="request-header">
        <div class="request-badges">
          <span class="type-badge">{{request.type}}</span>
          <span class="status-badge" [style.background-color]="getStatusColor(request.status)">
            {{getStatusLabel(request.status)}}
          </span>
          <span class="priority-badge" [style.background-color]="getPriorityColor(request.priority)">
            {{getPriorityLabel(request.priority)}}
          </span>
        </div>
        <div class="request-actions" (click)="$event.stopPropagation()">
          <button class="action-btn delete" (click)="deleteRequest(request.id)" title="Supprimer">
            <i class="material-icons">delete</i>
          </button>
        </div>
      </div>
      
      <div class="request-content">
        <h3 class="request-title">{{request.title}}</h3>
        <p class="request-description">{{request.description}}</p>
        
        <div class="request-meta">
          <div class="citizen-info">
            <i class="material-icons">person</i>
            <span>{{request.citizenName}}</span>
          </div>
          <div class="date-info">
            <i class="material-icons">schedule</i>
            <span>{{formatTimeAgo(request.createdAt)}}</span>
          </div>
          <div class="assigned-info" *ngIf="request.assignedTo">
            <i class="material-icons">assignment_ind</i>
            <span>{{request.assignedTo}}</span>
          </div>
        </div>
        
        <div class="request-documents" *ngIf="request.documents.length > 0">
          <i class="material-icons">attach_file</i>
          <span>{{request.documents.length}} document(s)</span>
        </div>
      </div>
    </div>
    
    <div *ngIf="filteredRequests.length === 0" class="no-results">
      <i class="material-icons">inbox</i>
      <p>Aucune demande trouvée</p>
    </div>
  </div>
</div>

<!-- Request Details Modal -->
<div class="modal-overlay" *ngIf="showRequestModal" (click)="closeRequestModal()">
  <div class="modal large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Détails de la demande #{{selectedRequest?.id}}</h2>
      <button class="close-btn" (click)="closeRequestModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body" *ngIf="selectedRequest">
      <div class="request-details">
        <!-- Request Info -->
        <div class="detail-section">
          <h3>Informations générales</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Type :</label>
              <span>{{selectedRequest.type}}</span>
            </div>
            <div class="detail-item">
              <label>Statut :</label>
              <select [(ngModel)]="selectedRequest.status" (change)="updateRequestStatus(selectedRequest.status)">
                <option value="pending">En attente</option>
                <option value="in_progress">En cours</option>
                <option value="completed">Terminé</option>
                <option value="rejected">Rejeté</option>
              </select>
            </div>
            <div class="detail-item">
              <label>Priorité :</label>
              <select [(ngModel)]="selectedRequest.priority" (change)="updatePriority(selectedRequest.priority)">
                <option value="low">Faible</option>
                <option value="medium">Moyenne</option>
                <option value="high">Élevée</option>
                <option value="urgent">Urgente</option>
              </select>
            </div>
            <div class="detail-item">
              <label>Assigné à :</label>
              <select [(ngModel)]="selectedRequest.assignedTo" (change)="assignRequest(selectedRequest.assignedTo || '')">
                <option value="">Non assigné</option>
                <option *ngFor="let agent of agents" [value]="agent">{{agent}}</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Citizen Info -->
        <div class="detail-section">
          <h3>Informations du citoyen</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Nom :</label>
              <span>{{selectedRequest.citizenName}}</span>
            </div>
            <div class="detail-item">
              <label>Email :</label>
              <a [href]="'mailto:' + selectedRequest.citizenEmail">{{selectedRequest.citizenEmail}}</a>
            </div>
            <div class="detail-item">
              <label>Téléphone :</label>
              <a [href]="'tel:' + selectedRequest.citizenPhone">{{selectedRequest.citizenPhone}}</a>
            </div>
          </div>
        </div>

        <!-- Request Description -->
        <div class="detail-section">
          <h3>Description</h3>
          <p class="description-text">{{selectedRequest.description}}</p>
        </div>

        <!-- Documents -->
        <div class="detail-section" *ngIf="selectedRequest.documents.length > 0">
          <h3>Documents joints</h3>
          <div class="documents-list">
            <div class="document-item" *ngFor="let doc of selectedRequest.documents">
              <i class="material-icons">description</i>
              <span>{{doc}}</span>
              <button class="btn-link">Télécharger</button>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div class="detail-section">
          <h3>Notes internes</h3>
          <div class="notes-list" *ngIf="selectedRequest.notes.length > 0">
            <div class="note-item" *ngFor="let note of selectedRequest.notes">
              {{note}}
            </div>
          </div>
          <div class="add-note">
            <textarea [(ngModel)]="newNote" placeholder="Ajouter une note interne..." rows="3"></textarea>
            <button class="btn btn-primary" (click)="addNote()" [disabled]="!newNote.trim()">
              Ajouter la note
            </button>
          </div>
        </div>

        <!-- Dates -->
        <div class="detail-section">
          <h3>Historique</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Créé le :</label>
              <span>{{selectedRequest.createdAt | date:'dd/MM/yyyy HH:mm'}}</span>
            </div>
            <div class="detail-item">
              <label>Modifié le :</label>
              <span>{{selectedRequest.updatedAt | date:'dd/MM/yyyy HH:mm'}}</span>
            </div>
            <div class="detail-item" *ngIf="selectedRequest.completedAt">
              <label>Terminé le :</label>
              <span>{{selectedRequest.completedAt | date:'dd/MM/yyyy HH:mm'}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
